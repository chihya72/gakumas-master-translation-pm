name: Combined Release Workflow

on:
  # åŽŸå§‹è§¦å‘æ¡ä»¶
  push:
    tags:
      - 'v*'
  workflow_dispatch:

  # æ–°å¢žè·¨ä»“åº“è§¦å‘
  repository_dispatch:
    types: [data-updated]

jobs:
  build:
    runs-on: ubuntu-latest
    concurrency:
      group: release-${{ github.event_name == 'repository_dispatch' && 'data-update' || github.ref }}
      cancel-in-progress: true

    steps:
      # ä»£ç æ£€å‡º
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'repository_dispatch' && 'main' || github.ref }}

      # Bé¡¹ç›®commitä¿¡æ¯æå–
      - name: Extract B Commit Info
        if: ${{ github.event_name == 'repository_dispatch' }}
        id: extract_b_info
        run: |
          echo "b_commit_sha=${{ github.event.client_payload.b_commit_sha }}" >> $GITHUB_OUTPUT
          echo "b_commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.client_payload.b_commit_msg }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ç›®å½•å‡†å¤‡
      - name: Prepare directories
        run: |
          rm -rf gakumas-local/local-files/resource/*
          mkdir -p gakumas-local/local-files/resource
          tree gakumas-local/local-files -L 2

      # æ•°æ®å…‹éš†ç­–ç•¥
      - name: Clone translation data
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "â¬‡ï¸ å¼ºåˆ¶èŽ·å–æœ€æ–°æ•°æ®ï¼ˆBé¡¹ç›®è§¦å‘ï¼‰"
            git clone --depth 1 https://github.com/chihya72/Gakumas-Auto-Translate.git temp-repo
          else
            echo "ðŸ·ï¸ ä½¿ç”¨æ ‡ç­¾å…³è”æ•°æ®ï¼ˆæ‰‹åŠ¨/æ ‡ç­¾è§¦å‘ï¼‰"
            git clone --branch ${{ github.ref_name }} https://github.com/chihya72/Gakumas-Auto-Translate.git temp-repo
          fi
          ls -l temp-repo/data/

      # æ•°æ®å¤åˆ¶
      - name: Copy translation data
        run: |
          cp -R temp-repo/data/* gakumas-local/local-files/resource/
          ls -l gakumas-local/local-files/resource/
          rm -rf temp-repo

      # æ‰“åŒ…æ“ä½œ
      - name: Create ZIP archive
        run: |
          zip -r gakumas-local.zip gakumas-local/
          unzip -l gakumas-local.zip | grep 'gakumas-local/local-files/resource'

      # åŠ¨æ€Releaseä¿¡æ¯
      - name: Generate Release Metadata
        id: set_release_name
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            SHORT_SHA="${{ steps.extract_b_info.outputs.b_commit_sha }}"
            SHORT_SHA=${SHORT_SHA:0:7}
            MSG="${{ steps.extract_b_info.outputs.b_commit_msg }}"
            
            # æ¸…ç†æ ‡é¢˜æ ¼å¼
            CLEAN_TITLE=$(echo "$MSG" | tr '\n' ' ' | cut -c -50 | sed 's/["*]//g')
            CLEAN_BODY=$(echo "$MSG" | sed 's/"/\\"/g')
            
            echo "name=Data Update: ${CLEAN_TITLE} (B@${SHORT_SHA})" >> $GITHUB_OUTPUT
            echo "body=**Triggered by B Commit:**\n\n\`\`\`\n${CLEAN_BODY}\n\`\`\`" >> $GITHUB_OUTPUT
          else
            echo "name=Release ${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "body=Standard versioned release" >> $GITHUB_OUTPUT
          fi

      # åˆ›å»ºRelease
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: gakumas-local.zip
          name: ${{ steps.set_release_name.outputs.name }}
          body: ${{ steps.set_release_name.outputs.body }}
          tag_name: ${{ github.event_name == 'repository_dispatch' && '' || github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}