name: Combined Release Workflow

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
  repository_dispatch:
    types: [data-updated]

jobs:
  build:
    runs-on: ubuntu-latest
    concurrency:
      group: release-${{ github.event_name == 'repository_dispatch' && 'data-update' || github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'repository_dispatch' && 'main' || github.ref }}

      - name: Extract B Commit Info
        if: ${{ github.event_name == 'repository_dispatch' }}
        id: extract_b_info
        run: |
          echo "b_commit_sha=${{ github.event.client_payload.b_commit_sha }}" >> $GITHUB_OUTPUT
          echo "b_commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.client_payload.b_commit_msg }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Prepare directories
        run: |
          rm -rf gakumas-local/local-files/resource/*
          mkdir -p gakumas-local/local-files/resource
          tree gakumas-local/local-files -L 2

      - name: Clone translation data
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            git clone --depth 1 https://github.com/chihya72/Gakumas-Auto-Translate.git temp-repo
          else
            git clone --branch ${{ github.ref_name }} https://github.com/chihya72/Gakumas-Auto-Translate.git temp-repo
          fi
          ls -l temp-repo/data/

      - name: Copy translation data
        run: |
          cp -R temp-repo/data/* gakumas-local/local-files/resource/
          ls -l gakumas-local/local-files/resource/
          rm -rf temp-repo

      - name: Create ZIP archive
        run: |
          zip -r gakumas-local.zip gakumas-local/
          unzip -l gakumas-local.zip | grep 'gakumas-local/local-files/resource'

      - name: Generate Release Metadata
        id: set_release_name
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            SHORT_SHA="${{ steps.extract_b_info.outputs.b_commit_sha }}"
            SHORT_SHA=${SHORT_SHA:0:7}
            RAW_MSG="${{ steps.extract_b_info.outputs.b_commit_msg }}"
            
            # 清理标题
            CLEAN_TITLE=$(echo "$RAW_MSG" | tr '\n' ' ' | cut -c -50 | sed 's/[“”"*]//g')
            
            # 构造带链接的Markdown
            COMMIT_URL="https://github.com/chihya72/Gakumas-Auto-Translate/commit/${{ steps.extract_b_info.outputs.b_commit_sha }}"
            MD_BODY=$(printf "**Triggered by [Gakumas-Auto-Translate Commit](%s):**\n\n\`\`\`\n%s\n\`\`\`" "${COMMIT_URL}" "${RAW_MSG}")

            echo "name=Data Update: ${CLEAN_TITLE} (Gakumas-Auto-Translate@${SHORT_SHA})" >> $GITHUB_OUTPUT
            echo "body=${MD_BODY}" >> $GITHUB_OUTPUT
          else
            echo "name=Release ${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "body=Standard versioned release" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: gakumas-local.zip
          name: ${{ steps.set_release_name.outputs.name }}
          body: ${{ steps.set_release_name.outputs.body }}
          tag_name: ${{ github.event_name == 'repository_dispatch' && '' || github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}